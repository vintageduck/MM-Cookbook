<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cookbook">
    <title>Mother Marston's Cookbook</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400;0,500;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* --- THEMING VARIABLES --- */
        :root {
            --bg: #0a0a0a;
            --card-bg: #161616;
            --card-border: #2a2a2a;
            --text-main: #e5e5e5;
            --text-muted: #888;
            --accent: #d4af37;
            --danger: #b33a3a;
            --overlay-bg: rgba(10, 10, 10, 0.95);
            
            --font-head: 'Playfair Display', serif;
            --font-body: 'Lora', serif;
            --font-ui: 'Inter', sans-serif;
        }

        [data-theme="light"] {
            --bg: #f9f9f9;
            --card-bg: #ffffff;
            --card-border: #e0e0e0;
            --text-main: #1a1a1a;
            --text-muted: #666;
            --accent: #b8860b;
            --danger: #d32f2f;
            --overlay-bg: rgba(255, 255, 255, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- ICONS --- */
        .icon-svg {
            width: 24px;
            height: 24px;
            fill: none;
            stroke: currentColor;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* --- NAV --- */
        nav {
            padding: 50px 24px 15px 24px;
            background: var(--bg);
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 50;
            transition: background 0.3s;
        }

        .nav-brand { 
            font-family: var(--font-head); 
            font-size: 1.1rem; 
            font-weight: 700; 
            font-style: italic; 
            letter-spacing: 0.5px;
        }
        
        .nav-actions { display: flex; gap: 15px; align-items: center; }

        button.icon-btn {
            background: none;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            opacity: 0.8;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        button.icon-btn:active { opacity: 0.5; }

        /* --- MAIN LIST --- */
        main {
            flex: 1;
            padding-top: 90px;
            padding-bottom: 40px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .header-section { padding: 25px 24px 10px 24px; }
        h1 { font-family: var(--font-head); font-size: 2.2rem; font-weight: 400; margin-bottom: 5px; line-height: 1.1; }
        .subtitle { font-size: 0.9rem; color: var(--text-muted); font-style: italic; margin-bottom: 25px; }

        /* --- FILTERS --- */
        .filter-section {
            padding: 0 24px 20px 24px;
            border-bottom: 1px solid var(--card-border);
        }

        .search-wrapper input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--card-border);
            color: var(--text-main);
            font-family: var(--font-body);
            font-size: 1rem;
            padding: 10px 0;
            margin-bottom: 20px;
            border-radius: 0;
        }
        .search-wrapper input:focus { outline: none; border-bottom: 1px solid var(--text-muted); }

        .tag-scroller {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none; 
        }
        .tag-scroller::-webkit-scrollbar { display: none; }

        .filter-tag {
            font-family: var(--font-ui);
            font-size: 0.75rem;
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            color: var(--text-muted);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .filter-tag.active {
            background: var(--text-main);
            color: var(--bg);
            border-color: var(--text-main);
        }

        /* --- RECIPE CARDS --- */
        .recipe-list { padding: 20px 24px; display: flex; flex-direction: column; gap: 20px; }

        .recipe-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px 0;
            border-bottom: 1px solid var(--card-border);
            position: relative;
            cursor: pointer;
            min-height: 80px;
            transition: opacity 0.2s;
        }
        .recipe-card:active { opacity: 0.6; }
        .recipe-card:last-child { border-bottom: none; }
        
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card-custom {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            overflow: hidden;
            border-radius: 4px;
            border: 1px solid var(--card-border);
            position: relative;
            background: var(--card-bg);
        }
        
        .recipe-info { flex: 1; min-width: 0; }
        .recipe-title { font-family: var(--font-head); font-size: 1.3rem; font-weight: 700; margin-bottom: 6px; line-height: 1.2; }
        
        .recipe-meta { 
            display: flex; 
            gap: 10px; 
            font-size: 0.75rem; 
            color: var(--text-muted); 
            font-family: var(--font-ui);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .recipe-tags { font-weight: 600; color: var(--accent); }

        .edit-trigger {
            padding: 10px;
            color: var(--text-muted);
            background: transparent;
            border: none;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .edit-trigger:hover { opacity: 1; color: var(--accent); }

        /* --- MODALS --- */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .modal.open { transform: translateY(0); }

        .modal-header {
            padding: 60px 24px 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--card-border);
            background: var(--bg);
        }

        .modal-body {
            flex: 1;
            padding: 30px 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .section-label {
            font-family: var(--font-ui);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-link {
            color: var(--accent);
            cursor: pointer;
            text-decoration: none;
            font-size: 0.7rem;
        }

        input[type="text"], textarea {
            width: 100%;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            padding: 15px;
            font-family: var(--font-body);
            font-size: 1rem;
            border-radius: 8px;
            appearance: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Custom Select Styling */
        .custom-select-wrapper {
            position: relative;
        }
        .custom-select-wrapper::after {
            content: "â†“";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.8rem;
            pointer-events: none;
        }
        select {
            width: 100%;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            padding: 15px;
            font-family: var(--font-ui);
            font-size: 1rem;
            border-radius: 8px;
            appearance: none;
            -webkit-appearance: none;
        }

        /* --- COLOUR PALETTE --- */
        .palette-row {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .swatch {
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            border: 2px solid transparent; 
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .swatch:active { transform: scale(0.9); }
        .swatch.selected { border-color: var(--text-main); }

        .code-input {
            font-family: 'Menlo', monospace;
            font-size: 0.8rem;
            min-height: 120px;
            line-height: 1.4;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .btn-full {
            width: 100%;
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            font-family: var(--font-ui);
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 12px;
            cursor: pointer;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-danger { 
            color: var(--danger); 
            border-color: rgba(179, 58, 58, 0.3); 
            margin-top: 40px; 
        }

        /* --- EDITOR TOGGLES --- */
        .card-type-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .toggle-btn {
            flex: 1;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-muted);
            font-family: var(--font-ui);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            text-align: center;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background: var(--text-main);
            color: var(--bg);
            border-color: var(--text-main);
        }

        .hidden { display: none; }

        /* --- VIEWER --- */
        .viewer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .viewer.open { transform: translateY(0); }
        .viewer-controls {
            position: absolute;
            bottom: 40px; left: 50%;
            transform: translateX(-50%);
            z-index: 210;
            display: flex;
            gap: 10px;
        }
        .close-pill {
            background: rgba(20,20,20,0.8);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 24px;
            border-radius: 30px;
            font-family: var(--font-ui);
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        .edit-pill {
            background: rgba(212, 175, 55, 0.9);
            color: black;
            border: none;
        }
        iframe { width: 100%; height: 100%; border: none; background: #fff; }

    </style>
</head>
<body>

    <!-- NAV -->
    <nav>
        <div class="nav-brand">HTCM</div>
        <div class="nav-actions">
            <!-- Settings SVG -->
            <button class="icon-btn" onclick="openSettings()">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                </svg>
            </button>
            <!-- Add SVG -->
            <button class="icon-btn" onclick="openEditor()">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
            </button>
        </div>
    </nav>

    <!-- MAIN -->
    <main>
        <div class="header-section">
            <h1>Mother Marston's Cookbook</h1>
            <div class="subtitle">Culinary essentials & experiments.</div>
        </div>

        <div class="filter-section">
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="Search collection..." onkeyup="filterRecipes()">
            </div>
            <div class="tag-scroller" id="tagList">
                <!-- Tags injected via JS -->
            </div>
        </div>

        <div class="recipe-list" id="recipeList">
            <!-- Recipes injected via JS -->
        </div>
    </main>

    <!-- EDITOR MODAL -->
    <div class="modal" id="editorModal">
        <div class="modal-header">
            <button class="icon-btn" style="font-size: 0.9rem; width: auto;" onclick="closeEditor()">Cancel</button>
            <span style="font-family: var(--font-head); font-style: italic;" id="editorTitle">New Entry</span>
            <button class="icon-btn" style="font-size: 0.9rem; color: var(--accent); width: auto;" onclick="saveRecipe()" id="saveBtn">Save</button>
        </div>
        
        <div class="modal-body">
            
            <!-- Metadata -->
            <div>
                <span class="section-label">Details</span>
                <input type="text" id="inputTitle" placeholder="Recipe Title" style="margin-bottom: 15px;">
                <input type="text" id="inputTags" placeholder="Tags (e.g. Dinner, Fast)" style="font-size: 0.9rem;">
            </div>

            <!-- Card Customisation -->
            <div>
                <span class="section-label">Card Style</span>
                <div class="card-type-toggle">
                    <div class="toggle-btn active" onclick="setCardMode('icon')" id="btnModeIcon">Icon</div>
                    <div class="toggle-btn" onclick="setCardMode('custom')" id="btnModeCustom">Custom HTML</div>
                </div>

                <!-- Icon Mode Inputs -->
                <div id="iconInputs">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <input type="text" id="inputEmoji" placeholder="ðŸŒ®" maxlength="2" style="font-size: 1.5rem; width: 60px; text-align: center; border-radius: 8px;">
                        <div style="flex:1;">
                            <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Background Colour</span>
                            <div class="palette-row" id="colorPalette">
                                <!-- Generated by JS -->
                            </div>
                            <!-- Hidden actual input -->
                            <input type="color" id="inputColor" value="#333333" style="visibility: hidden; height: 0; width:0; position: absolute;">
                        </div>
                    </div>
                </div>

                <!-- Custom Card Input -->
                <div id="customCardInputs" class="hidden">
                    <div class="section-label" style="margin-bottom: 5px;">
                        <span>HTML Snippet</span>
                        <span class="action-link" onclick="insertTemplate()">Insert Template</span>
                    </div>
                    <textarea class="code-input" id="inputCardHTML" placeholder="<div><b>My Custom Card</b></div>"></textarea>
                </div>
            </div>
            
            <!-- Recipe Code -->
            <div>
                <span class="section-label">Recipe Content (Full HTML)</span>
                <textarea class="code-input" id="inputCode" placeholder="Paste generated recipe HTML here..." style="min-height: 200px;"></textarea>
            </div>

            <!-- Delete Button (Only shows when editing) -->
            <button class="btn-full btn-danger hidden" id="deleteEntryBtn" onclick="deleteRecipeFromEditor()">Delete Entry</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal" id="settingsModal">
        <div class="modal-header">
            <button class="icon-btn" style="font-size: 0.9rem; width: auto;" onclick="closeSettings()">Done</button>
            <span style="font-family: var(--font-head);">Settings</span>
            <div style="width: 40px;"></div>
        </div>
        <div class="modal-body">
            
            <div class="setting-row">
                <span class="setting-label">Appearance</span>
                <div class="custom-select-wrapper">
                    <select id="themeSelect" onchange="changeTheme()">
                        <option value="system">System Default</option>
                        <option value="dark">Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 40px;">
                <span class="section-label">Data Management</span>
                <button class="btn-full" onclick="exportData()">Export Backup (JSON)</button>
                <div style="position: relative;">
                    <button class="btn-full" onclick="document.getElementById('importFile').click()">Import Backup</button>
                    <input type="file" id="importFile" style="display: none;" onchange="importData(this)">
                </div>
                <button class="btn-full btn-danger" onclick="resetAllData()">Reset All Data</button>
            </div>
            
            <div style="margin-top: auto; text-align: center; color: var(--text-muted); font-size: 0.7rem; opacity: 0.5;">
                Mother Marston's Cookbook v0.4
            </div>
        </div>
    </div>

    <!-- VIEWER -->
    <div class="viewer" id="recipeViewer">
        <div class="viewer-controls">
            <button class="close-pill" onclick="closeViewer()">Close</button>
            <button class="close-pill edit-pill" onclick="editCurrentRecipe()">Edit</button>
        </div>
        <iframe id="contentFrame"></iframe>
    </div>

    <script>
        // --- DATA STRUCTURE & INIT ---
        const DB_KEY = 'mm_cookbook_v3';
        const SETTINGS_KEY = 'mm_settings_v3';
        
        const PALETTE = [
            '#2c3e50', '#c0392b', '#27ae60', '#d35400', 
            '#8e44ad', '#d4af37', '#7f8c8d', '#16a085'
        ];

        let recipes = [];
        let settings = { theme: 'system' };
        let editingId = null; // Tracks which recipe is being edited
        let viewingId = null; // Tracks which recipe is currently being viewed

        const fajitaCode = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fajitas</title><style>body{margin:0;font-family:sans-serif;background:#111;color:#fff;text-align:center;display:flex;flex-direction:column;justify-content:center;height:100vh}h1{font-size:3rem}</style></head><body><h1>Fajitas</h1><p>The Classic.</p></body></html>`;

        function init() {
            // Load Settings
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            if (savedSettings) settings = JSON.parse(savedSettings);
            applyTheme(settings.theme);
            document.getElementById('themeSelect').value = settings.theme;

            // Generate Palette
            const paletteContainer = document.getElementById('colorPalette');
            paletteContainer.innerHTML = ''; // Clear just in case
            PALETTE.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'swatch';
                swatch.style.backgroundColor = color;
                swatch.onclick = () => selectColor(color, swatch);
                paletteContainer.appendChild(swatch);
            });

            // Load Recipes
            const savedRecipes = localStorage.getItem(DB_KEY);
            if (savedRecipes) {
                recipes = JSON.parse(savedRecipes);
            } else {
                recipes = [{
                    id: Date.now(),
                    title: "Mother Marston's Fajitas",
                    tags: ["Dinner", "Mexican"],
                    cardMode: "icon",
                    emoji: "ðŸŒ®",
                    color: "#2c3e50",
                    code: fajitaCode,
                    date: new Date().toISOString()
                }];
                saveData();
            }

            renderTags();
            renderList();
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(recipes));
        }

        // --- COLOUR SELECTION ---
        function selectColor(color, element) {
            document.getElementById('inputColor').value = color;
            document.querySelectorAll('.swatch').forEach(el => el.classList.remove('selected'));
            if(element) element.classList.add('selected');
        }

        // --- THEME LOGIC ---
        function changeTheme() {
            const val = document.getElementById('themeSelect').value;
            settings.theme = val;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            applyTheme(val);
        }

        function applyTheme(theme) {
            const html = document.documentElement;
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                html.setAttribute('data-theme', theme);
            }
        }

        // --- RENDER LOGIC ---
        let activeTag = 'All';

        function renderTags() {
            const tagContainer = document.getElementById('tagList');
            const allTags = new Set(['All']);
            recipes.forEach(r => {
                if(r.tags) r.tags.forEach(t => allTags.add(t.trim()));
            });

            tagContainer.innerHTML = '';
            allTags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = `filter-tag ${tag === activeTag ? 'active' : ''}`;
                btn.textContent = tag;
                btn.onclick = () => {
                    activeTag = tag;
                    renderTags();
                    renderList();
                };
                tagContainer.appendChild(btn);
            });
        }

        function renderList() {
            const listContainer = document.getElementById('recipeList');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            listContainer.innerHTML = '';

            const filtered = recipes.filter(r => {
                const matchesSearch = r.title.toLowerCase().includes(searchVal);
                const matchesTag = activeTag === 'All' || (r.tags && r.tags.includes(activeTag));
                return matchesSearch && matchesTag;
            });

            if (filtered.length === 0) {
                listContainer.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">No entries found.</div>`;
                return;
            }

            filtered.forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'recipe-card';
                // Click card to VIEW
                card.onclick = (e) => {
                    if(!e.target.closest('.edit-trigger')) openViewer(recipe.id);
                };

                let visualBlock = '';
                
                if (recipe.cardMode === 'custom' && recipe.cardHTML) {
                    visualBlock = `<div class="card-custom">${recipe.cardHTML}</div>`;
                } else {
                    const bg = recipe.color || '#333';
                    const em = recipe.emoji || 'ðŸ“„';
                    visualBlock = `<div class="card-icon" style="background-color: ${bg}; color: #fff;">${em}</div>`;
                }

                const tagString = recipe.tags ? recipe.tags.join(', ') : '';
                const dateStr = new Date(recipe.date).toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });

                card.innerHTML = `
                    ${visualBlock}
                    <div class="recipe-info">
                        <div class="recipe-title">${recipe.title}</div>
                        <div class="recipe-meta">
                            <span class="recipe-tags">${tagString}</span>
                            <span>â€¢</span>
                            <span>${dateStr}</span>
                        </div>
                    </div>
                    <!-- PENCIL ICON FOR EDITING -->
                    <button class="edit-trigger" onclick="openEditor(${recipe.id})">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width:20px; height:20px;">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                        </svg>
                    </button>
                `;
                listContainer.appendChild(card);
            });
        }

        function filterRecipes() { renderList(); }

        // --- EDITOR LOGIC ---
        let currentCardMode = 'icon';

        // openEditor can now accept an ID to load existing data
        function openEditor(id = null) {
            editingId = id; // Set global state
            const deleteBtn = document.getElementById('deleteEntryBtn');
            const editorTitle = document.getElementById('editorTitle');
            const saveBtn = document.getElementById('saveBtn');

            if (id) {
                // EDIT MODE
                const recipe = recipes.find(r => r.id === id);
                if (!recipe) return;

                editorTitle.textContent = "Edit Entry";
                saveBtn.textContent = "Update";
                deleteBtn.classList.remove('hidden');

                document.getElementById('inputTitle').value = recipe.title;
                document.getElementById('inputTags').value = recipe.tags ? recipe.tags.join(', ') : '';
                document.getElementById('inputCode').value = recipe.code;
                
                setCardMode(recipe.cardMode || 'icon');

                if (recipe.cardMode === 'custom') {
                    document.getElementById('inputCardHTML').value = recipe.cardHTML || '';
                } else {
                    document.getElementById('inputEmoji').value = recipe.emoji || '';
                    document.getElementById('inputColor').value = recipe.color || '#333';
                    // Highlight correct swatch
                    const swatches = document.querySelectorAll('.swatch');
                    swatches.forEach(s => {
                        s.classList.remove('selected');
                        // Simple hex comparison
                        if (s.style.backgroundColor === hexToRgb(recipe.color)) s.classList.add('selected'); 
                    });
                }
            } else {
                // CREATE MODE
                editorTitle.textContent = "New Entry";
                saveBtn.textContent = "Save";
                deleteBtn.classList.add('hidden');

                document.getElementById('inputTitle').value = '';
                document.getElementById('inputTags').value = '';
                document.getElementById('inputCode').value = '';
                document.getElementById('inputCardHTML').value = '';
                document.getElementById('inputEmoji').value = '';
                
                // Reset Color to first in palette
                selectColor(PALETTE[0], document.querySelector('.swatch'));
                setCardMode('icon');
            }
            
            document.getElementById('editorModal').classList.add('open');
        }

        function closeEditor() { 
            document.getElementById('editorModal').classList.remove('open'); 
            editingId = null;
        }

        function setCardMode(mode) {
            currentCardMode = mode;
            document.getElementById('btnModeIcon').classList.toggle('active', mode === 'icon');
            document.getElementById('btnModeCustom').classList.toggle('active', mode === 'custom');
            
            if (mode === 'icon') {
                document.getElementById('iconInputs').classList.remove('hidden');
                document.getElementById('customCardInputs').classList.add('hidden');
            } else {
                document.getElementById('iconInputs').classList.add('hidden');
                document.getElementById('customCardInputs').classList.remove('hidden');
            }
        }

        function insertTemplate() {
            const template = `<div style="width:100%; height:100%; background:#f3e5ab; color:#333; padding:8px; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
    <div style="font-family:serif; font-weight:bold; font-size:0.6rem; border-bottom:1px solid #333; width:100%; margin-bottom:4px;">DAILY NEWS</div>
    <div style="font-family:sans-serif; font-weight:900; font-size:1.5rem; line-height:1;">A+</div>
</div>`;
            document.getElementById('inputCardHTML').value = template;
        }

        function saveRecipe() {
            const title = document.getElementById('inputTitle').value.trim();
            const tagsStr = document.getElementById('inputTags').value;
            const code = document.getElementById('inputCode').value.trim();
            
            if (!title || !code) { alert("Title and Recipe Code are required."); return; }

            const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t.length > 0);

            const recipeData = {
                title: title,
                tags: tags,
                code: code,
                date: new Date().toISOString(),
                cardMode: currentCardMode
            };

            if (currentCardMode === 'icon') {
                recipeData.color = document.getElementById('inputColor').value;
                recipeData.emoji = document.getElementById('inputEmoji').value || 'ðŸ¥˜';
            } else {
                recipeData.cardHTML = document.getElementById('inputCardHTML').value;
            }

            if (editingId) {
                // UPDATE EXISTING
                const index = recipes.findIndex(r => r.id === editingId);
                if (index !== -1) {
                    recipes[index] = { ...recipes[index], ...recipeData };
                }
            } else {
                // CREATE NEW
                recipeData.id = Date.now();
                recipes.unshift(recipeData);
            }

            saveData();
            renderTags();
            renderList();
            closeEditor();
        }

        function deleteRecipeFromEditor() {
            if (!editingId) return;
            if(confirm("Are you sure you want to delete this recipe? This cannot be undone.")) {
                const index = recipes.findIndex(r => r.id === editingId);
                if (index !== -1) {
                    recipes.splice(index, 1);
                    saveData();
                    renderTags();
                    renderList();
                    closeEditor();
                }
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;
            
            viewingId = id; // Track what we are viewing
            const viewer = document.getElementById('recipeViewer');
            const iframe = document.getElementById('contentFrame');
            
            viewer.classList.add('open');
            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(recipe.code);
            doc.close();
        }

        function closeViewer() {
            document.getElementById('recipeViewer').classList.remove('open');
            viewingId = null;
            setTimeout(() => {
                const iframe = document.getElementById('contentFrame');
                iframe.contentWindow.document.open();
                iframe.contentWindow.document.write('');
                iframe.contentWindow.document.close();
            }, 400);
        }

        function editCurrentRecipe() {
            if (viewingId) {
                closeViewer(); // Close viewer first
                // Small timeout to allow viewer transition to start before opening editor
                setTimeout(() => openEditor(viewingId), 300);
            }
        }

        // --- HELPER ---
        // Basic Hex to RGB check for setting "selected" class on swatches
        function hexToRgb(hex) {
            // This is a naive check, mostly works if inputs are standard hex
            // Browsers often convert style.backgroundColor to rgb(), so exact string match might fail without parsing
            // For this simple app, we just trust the user re-clicks if needed, or implement a converter if strict match needed.
            return hex; 
        }

        // --- SETTINGS ---
        function openSettings() { document.getElementById('settingsModal').classList.add('open'); }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(recipes));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "cookbook_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        recipes = imported;
                        saveData();
                        renderTags();
                        renderList();
                        alert("Import successful!");
                        closeSettings();
                    } else {
                        alert("Invalid file format.");
                    }
                } catch(err) { alert("Error reading file."); }
            };
            reader.readAsText(file);
        }

        function resetAllData() {
            if(confirm("WARNING: This will delete ALL recipes. Are you sure?")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        // --- BOOT ---
        init();

    </script>
</body>
</html>
